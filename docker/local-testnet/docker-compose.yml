# Local Testnet - 20 Nodes with NAT Simulation
# Run comprehensive ant-quic testing locally with various NAT configurations
#
# Network Topology:
#   testnet-public (172.30.0.0/16) - Public network (registry + bootstrap)
#   testnet-nat-* (10.200.X.0/24)  - Private networks behind various NATs
#
# Usage:
#   ./scripts/local-testnet.sh start    # Start full testnet
#   ./scripts/local-testnet.sh stop     # Stop testnet
#   ./scripts/local-testnet.sh status   # View node status
#   ./scripts/local-testnet.sh logs     # View logs

networks:
  # Public network - registry and direct nodes live here
  testnet-public:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

  # NAT internal networks
  nat-fullcone-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.200.1.0/24

  nat-restricted-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.200.2.0/24

  nat-portrestricted-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.200.3.0/24

  nat-symmetric-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.200.4.0/24

  nat-cgnat-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.200.5.0/24

services:
  # ============================================================
  # REGISTRY & BOOTSTRAP NODES (Public Network)
  # ============================================================
  registry:
    image: alpine:3.19
    container_name: testnet-registry
    hostname: registry
    networks:
      testnet-public:
        ipv4_address: 172.30.0.10
    ports:
      - "18080:8080"    # Registry HTTP API
      - "19001:9001/udp" # QUIC discovery
    volumes:
      - ./bin:/opt/bin:ro
      - registry-data:/data
    working_dir: /data
    command: >
      sh -c "
        echo 'Starting registry server...';
        if [ -f /opt/bin/saorsa-quic-test ]; then
          /opt/bin/saorsa-quic-test --registry --port 8080 --quic-port 9001;
        else
          echo 'ERROR: Test binary not found at /opt/bin/saorsa-quic-test';
          echo 'Run: ./scripts/local-testnet.sh build';
          sleep infinity;
        fi
      "
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Direct public nodes (no NAT) - 3 nodes
  node-public-1:
    image: alpine:3.19
    container_name: testnet-public-1
    hostname: public-1
    depends_on:
      registry:
        condition: service_healthy
    networks:
      testnet-public:
        ipv4_address: 172.30.0.11
    volumes:
      - ./bin:/opt/bin:ro
      - public1-data:/data
    working_dir: /data
    command: >
      sh -c "
        sleep 5;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-public-2:
    image: alpine:3.19
    container_name: testnet-public-2
    hostname: public-2
    depends_on:
      registry:
        condition: service_healthy
    networks:
      testnet-public:
        ipv4_address: 172.30.0.12
    volumes:
      - ./bin:/opt/bin:ro
      - public2-data:/data
    working_dir: /data
    command: >
      sh -c "
        sleep 6;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-public-3:
    image: alpine:3.19
    container_name: testnet-public-3
    hostname: public-3
    depends_on:
      registry:
        condition: service_healthy
    networks:
      testnet-public:
        ipv4_address: 172.30.0.13
    volumes:
      - ./bin:/opt/bin:ro
      - public3-data:/data
    working_dir: /data
    command: >
      sh -c "
        sleep 7;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  # ============================================================
  # FULL CONE NAT - 4 nodes behind it
  # ============================================================
  nat-fullcone:
    build:
      context: ../nat-emulation/nat-fullcone
    container_name: testnet-nat-fullcone
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      testnet-public:
        ipv4_address: 172.30.1.1
      nat-fullcone-internal:
        ipv4_address: 10.200.1.1
    restart: unless-stopped

  node-fullcone-1:
    image: alpine:3.19
    container_name: testnet-fullcone-1
    hostname: fullcone-1
    depends_on:
      - nat-fullcone
      - registry
    networks:
      nat-fullcone-internal:
        ipv4_address: 10.200.1.11
    volumes:
      - ./bin:/opt/bin:ro
      - fullcone1-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.1.1;
        sleep 10;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-fullcone-2:
    image: alpine:3.19
    container_name: testnet-fullcone-2
    hostname: fullcone-2
    depends_on:
      - nat-fullcone
      - registry
    networks:
      nat-fullcone-internal:
        ipv4_address: 10.200.1.12
    volumes:
      - ./bin:/opt/bin:ro
      - fullcone2-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.1.1;
        sleep 11;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-fullcone-3:
    image: alpine:3.19
    container_name: testnet-fullcone-3
    hostname: fullcone-3
    depends_on:
      - nat-fullcone
      - registry
    networks:
      nat-fullcone-internal:
        ipv4_address: 10.200.1.13
    volumes:
      - ./bin:/opt/bin:ro
      - fullcone3-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.1.1;
        sleep 12;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-fullcone-4:
    image: alpine:3.19
    container_name: testnet-fullcone-4
    hostname: fullcone-4
    depends_on:
      - nat-fullcone
      - registry
    networks:
      nat-fullcone-internal:
        ipv4_address: 10.200.1.14
    volumes:
      - ./bin:/opt/bin:ro
      - fullcone4-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.1.1;
        sleep 13;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  # ============================================================
  # PORT-RESTRICTED NAT - 4 nodes behind it
  # ============================================================
  nat-portrestricted:
    build:
      context: ../nat-emulation/nat-portrestricted
    container_name: testnet-nat-portrestricted
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      testnet-public:
        ipv4_address: 172.30.3.1
      nat-portrestricted-internal:
        ipv4_address: 10.200.3.1
    restart: unless-stopped

  node-portrestricted-1:
    image: alpine:3.19
    container_name: testnet-portrestricted-1
    hostname: portrestricted-1
    depends_on:
      - nat-portrestricted
      - registry
    networks:
      nat-portrestricted-internal:
        ipv4_address: 10.200.3.11
    volumes:
      - ./bin:/opt/bin:ro
      - portrestricted1-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.3.1;
        sleep 15;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-portrestricted-2:
    image: alpine:3.19
    container_name: testnet-portrestricted-2
    hostname: portrestricted-2
    depends_on:
      - nat-portrestricted
      - registry
    networks:
      nat-portrestricted-internal:
        ipv4_address: 10.200.3.12
    volumes:
      - ./bin:/opt/bin:ro
      - portrestricted2-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.3.1;
        sleep 16;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-portrestricted-3:
    image: alpine:3.19
    container_name: testnet-portrestricted-3
    hostname: portrestricted-3
    depends_on:
      - nat-portrestricted
      - registry
    networks:
      nat-portrestricted-internal:
        ipv4_address: 10.200.3.13
    volumes:
      - ./bin:/opt/bin:ro
      - portrestricted3-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.3.1;
        sleep 17;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-portrestricted-4:
    image: alpine:3.19
    container_name: testnet-portrestricted-4
    hostname: portrestricted-4
    depends_on:
      - nat-portrestricted
      - registry
    networks:
      nat-portrestricted-internal:
        ipv4_address: 10.200.3.14
    volumes:
      - ./bin:/opt/bin:ro
      - portrestricted4-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.3.1;
        sleep 18;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  # ============================================================
  # SYMMETRIC NAT - 4 nodes behind it (hardest)
  # ============================================================
  nat-symmetric:
    build:
      context: ../nat-emulation/nat-symmetric
    container_name: testnet-nat-symmetric
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      testnet-public:
        ipv4_address: 172.30.4.1
      nat-symmetric-internal:
        ipv4_address: 10.200.4.1
    restart: unless-stopped

  node-symmetric-1:
    image: alpine:3.19
    container_name: testnet-symmetric-1
    hostname: symmetric-1
    depends_on:
      - nat-symmetric
      - registry
    networks:
      nat-symmetric-internal:
        ipv4_address: 10.200.4.11
    volumes:
      - ./bin:/opt/bin:ro
      - symmetric1-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.4.1;
        sleep 20;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-symmetric-2:
    image: alpine:3.19
    container_name: testnet-symmetric-2
    hostname: symmetric-2
    depends_on:
      - nat-symmetric
      - registry
    networks:
      nat-symmetric-internal:
        ipv4_address: 10.200.4.12
    volumes:
      - ./bin:/opt/bin:ro
      - symmetric2-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.4.1;
        sleep 21;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-symmetric-3:
    image: alpine:3.19
    container_name: testnet-symmetric-3
    hostname: symmetric-3
    depends_on:
      - nat-symmetric
      - registry
    networks:
      nat-symmetric-internal:
        ipv4_address: 10.200.4.13
    volumes:
      - ./bin:/opt/bin:ro
      - symmetric3-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.4.1;
        sleep 22;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-symmetric-4:
    image: alpine:3.19
    container_name: testnet-symmetric-4
    hostname: symmetric-4
    depends_on:
      - nat-symmetric
      - registry
    networks:
      nat-symmetric-internal:
        ipv4_address: 10.200.4.14
    volumes:
      - ./bin:/opt/bin:ro
      - symmetric4-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.4.1;
        sleep 23;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  # ============================================================
  # CGNAT - 4 nodes behind it (port exhaustion testing)
  # ============================================================
  nat-cgnat:
    build:
      context: ../nat-emulation/nat-cgnat
    container_name: testnet-nat-cgnat
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      testnet-public:
        ipv4_address: 172.30.5.1
      nat-cgnat-internal:
        ipv4_address: 10.200.5.1
    restart: unless-stopped

  node-cgnat-1:
    image: alpine:3.19
    container_name: testnet-cgnat-1
    hostname: cgnat-1
    depends_on:
      - nat-cgnat
      - registry
    networks:
      nat-cgnat-internal:
        ipv4_address: 10.200.5.11
    volumes:
      - ./bin:/opt/bin:ro
      - cgnat1-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.5.1;
        sleep 25;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-cgnat-2:
    image: alpine:3.19
    container_name: testnet-cgnat-2
    hostname: cgnat-2
    depends_on:
      - nat-cgnat
      - registry
    networks:
      nat-cgnat-internal:
        ipv4_address: 10.200.5.12
    volumes:
      - ./bin:/opt/bin:ro
      - cgnat2-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.5.1;
        sleep 26;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-cgnat-3:
    image: alpine:3.19
    container_name: testnet-cgnat-3
    hostname: cgnat-3
    depends_on:
      - nat-cgnat
      - registry
    networks:
      nat-cgnat-internal:
        ipv4_address: 10.200.5.13
    volumes:
      - ./bin:/opt/bin:ro
      - cgnat3-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.5.1;
        sleep 27;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

  node-cgnat-4:
    image: alpine:3.19
    container_name: testnet-cgnat-4
    hostname: cgnat-4
    depends_on:
      - nat-cgnat
      - registry
    networks:
      nat-cgnat-internal:
        ipv4_address: 10.200.5.14
    volumes:
      - ./bin:/opt/bin:ro
      - cgnat4-data:/data
    working_dir: /data
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.200.5.1;
        sleep 28;
        /opt/bin/saorsa-quic-test --quiet --registry-url http://172.30.0.10:8080 --max-peers 20;
      "
    restart: unless-stopped

volumes:
  registry-data:
  public1-data:
  public2-data:
  public3-data:
  fullcone1-data:
  fullcone2-data:
  fullcone3-data:
  fullcone4-data:
  portrestricted1-data:
  portrestricted2-data:
  portrestricted3-data:
  portrestricted4-data:
  symmetric1-data:
  symmetric2-data:
  symmetric3-data:
  symmetric4-data:
  cgnat1-data:
  cgnat2-data:
  cgnat3-data:
  cgnat4-data:
